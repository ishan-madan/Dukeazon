{% extends "base.html" %}

{% block content %}
{% set primary_fulfillment_status = items[0].fulfillment_status if items else 'Order Placed' %}
{% set pill_class = 'order-placed' if primary_fulfillment_status == 'Order Placed' else ('shipped' if primary_fulfillment_status == 'Shipped' else 'delivered') %}
<div class="hero-panel">
  <div>
    <div class="eyebrow mb-2">Order Detail</div>
    <h1 class="mb-2">Order #{{ order.id }}</h1>
    <p class="muted mb-0">Placed {{ order.created_at | friendly_datetime }}</p>
  </div>
  <div class="text-right">
    <span class="status-pill-top {{ pill_class }}">{{ primary_fulfillment_status }}</span>
    <div class="text-uppercase small muted mt-3">Total</div>
    <div class="hero-total">${{ "{:,.2f}".format(order.total_amount) }}</div>
    <div class="mt-3">
      <a href="{{ url_for('cart.orders', user_id=user_id) }}" class="btn btn-outline-light btn-sm mr-2">Back to Orders</a>
      <a href="{{ url_for('cart.cart', user_id=user_id) }}" class="btn btn-light btn-sm text-dark">Back to Cart</a>
    </div>
  </div>
</div>

<style>
  .order-table thead th {
    background: #f2f5f9;
    text-transform: uppercase;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
  }
  .order-table td,
  .order-table th {
    vertical-align: middle;
  }
  .review-actions {
    min-width: 180px;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .review-actions .btn {
    width: 100%;
  }
  .review-actions .locked-note {
    font-size: 0.82rem;
    color: #6c7a92;
  }
</style>

{% if items %}
  <div class="card card-lift mb-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-modern order-table mb-0">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Product</th>
              <th scope="col">Seller</th>
              <th scope="col" class="text-right">Unit Price</th>
              <th scope="col">Quantity</th>
              <th scope="col" class="text-right">Subtotal</th>
              <th scope="col">Fulfillment</th>
              <th scope="col">Reviews</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ item.product_name }}</td>
              <td>
                <a href="{{ url_for('users.public_profile', user_id=item.seller_id) }}"
                   class="profile-popup-link"
                   data-profile-title="{{ item.seller_name }}">
                  {{ item.seller_name }}
                </a>
              </td>
              <td class="text-right">${{ "{:,.2f}".format(item.unit_price) }}</td>
              <td>{{ item.quantity }}</td>
              <td class="text-right">${{ "{:,.2f}".format(item.subtotal) }}</td>
              <td>
                {% set status_class = 'order-placed' if item.fulfillment_status == 'Order Placed' else ('shipped' if item.fulfillment_status == 'Shipped' else 'delivered') %}
                <span class="status-pill {{ status_class }} mb-1">{{ item.fulfillment_status }}</span>
                {% if item.fulfilled_at %}
                <div class="small text-muted">at {{ item.fulfilled_at | friendly_datetime }}</div>
                {% endif %}
              </td>
              <td>
                <div class="review-actions">
                {% if current_user.is_authenticated and current_user.id == user_id and item.fulfillment_status == 'Delivered' %}
                  {% if item.seller_id != current_user.id %}
                    <div>
                      {% set existing_review_id = seller_reviews_map.get(item.seller_id) if seller_reviews_map is defined else None %}
                      {% if existing_review_id %}
                        <a href="{{ url_for('social.seller_review', seller_id=item.seller_id) }}" class="btn btn-sm btn-outline-primary">Edit Seller Review</a>
                      {% else %}
                        <a href="{{ url_for('social.seller_review', seller_id=item.seller_id) }}" class="btn btn-sm btn-outline-primary">Leave Seller Review</a>
                      {% endif %}
                    </div>
                  {% endif %}
                  <a href="{{ url_for('social.product_review', product_id=item.product_id) }}" class="btn btn-sm btn-outline-success">Product Review</a>
                {% else %}
                  <small class="locked-note">Reviews unlock once this item is delivered.</small>
                {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% else %}
  <div class="card card-lift text-center p-5">
    <h4>No items found for this order.</h4>
    <p class="text-muted">If this seems wrong, please contact support.</p>
  </div>
{% endif %}
{% endblock %}
