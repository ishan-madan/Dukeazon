{% extends "base.html" %}

{% block content %}
{% set pill_class = 'success' if is_fulfilled else ('info' if display_status == 'partial' else 'warning') %}
<div class="hero-panel">
  <div>
    <div class="eyebrow mb-2">Order Detail</div>
    <h1 class="mb-2">Order #{{ order.id }}</h1>
    <p class="muted mb-0">Placed {{ order.created_at | friendly_datetime }}</p>
  </div>
  <div class="text-right">
    <span class="status-pill {{ pill_class }}">{{ display_status|capitalize }}</span>
    <div class="text-uppercase small muted mt-3">Total</div>
    <div class="hero-total">${{ "{:,.2f}".format(order.total_amount) }}</div>
    <div class="mt-3">
      <a href="{{ url_for('cart.orders', user_id=user_id) }}" class="btn btn-outline-light btn-sm mr-2">Back to Orders</a>
      <a href="{{ url_for('cart.cart', user_id=user_id) }}" class="btn btn-light btn-sm text-dark">Back to Cart</a>
    </div>
  </div>
</div>

{% if items %}
  <div class="card card-lift mb-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-modern mb-0">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Product</th>
              <th scope="col">Seller</th>
              <th scope="col" class="text-right">Unit Price</th>
              <th scope="col">Quantity</th>
              <th scope="col" class="text-right">Subtotal</th>
              <th scope="col">Fulfillment</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ item.product_name }}</td>
              <td>{{ item.seller_name }}</td>
              <td class="text-right">${{ "{:,.2f}".format(item.unit_price) }}</td>
              <td>{{ item.quantity }}</td>
              <td class="text-right">${{ "{:,.2f}".format(item.subtotal) }}</td>
              <td>
                {% if item.fulfilled %}
                  <span class="status-pill success mb-1">Fulfilled</span>
                  {% if item.fulfilled_at %}
                  <div class="small text-muted">at {{ item.fulfilled_at | friendly_datetime }}</div>
                  {% endif %}
                  {% if current_user.is_authenticated and current_user.id == user_id and item.seller_id != current_user.id %}
                    <div class="mt-2">
                      {% set existing_review_id = seller_reviews_map.get(item.seller_id) if seller_reviews_map is defined else None %}
                      {% if existing_review_id %}
                        <a href="{{ url_for('social.seller_review', seller_id=item.seller_id) }}" class="btn btn-sm btn-outline-primary">Update Review</a>
                        <div class="small text-muted mt-1">You have already reviewed this seller.</div>
                      {% else %}
                        <a href="{{ url_for('social.seller_review', seller_id=item.seller_id) }}" class="btn btn-sm btn-outline-primary">Save Review</a>
                      {% endif %}
                    </div>
                  {% endif %}
                {% else %}
                  <span class="status-pill warning">Pending</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% else %}
  <div class="card card-lift text-center p-5">
    <h4>No items found for this order.</h4>
    <p class="text-muted">If this seems wrong, please contact support.</p>
  </div>
{% endif %}
{% endblock %}
