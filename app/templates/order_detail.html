{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Order #{{ order.id }}</h1>
    <div>
      <a href="{{ url_for('cart.orders', user_id=user_id) }}" class="btn btn-outline-secondary mr-2">Back to Orders</a>
      <a href="{{ url_for('cart.cart', user_id=user_id) }}" class="btn btn-secondary">Back to Cart</a>
    </div>
  </div>
  <p class="text-muted mb-4">
    Placed {{ order.created_at | friendly_datetime }} â€¢
    <span class="badge badge-{{ 'success' if is_fulfilled else 'warning' }}">{{ display_status|capitalize }}</span>
  </p>

  {% if items %}
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Product</th>
          <th scope="col">Seller</th>
          <th scope="col">Unit Price</th>
          <th scope="col">Quantity</th>
          <th scope="col">Subtotal</th>
          <th scope="col">Fulfillment</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <th scope="row">{{ loop.index }}</th>
          <td>{{ item.product_name }}</td>
          <td>{{ item.seller_name }}</td>
          <td>${{ "{:,.2f}".format(item.unit_price) }}</td>
          <td>{{ item.quantity }}</td>
          <td>${{ "{:,.2f}".format(item.subtotal) }}</td>
          <td>
            {% if item.fulfilled %}
              <span class="badge badge-success">Fulfilled</span>
              {% if item.fulfilled_at %}
              <div class="small text-muted">at {{ item.fulfilled_at }}</div>
              {% endif %}
              {# Allow buyer to leave a seller review for this seller once item is fulfilled #}
              {% if current_user.is_authenticated and current_user.id == user_id and item.seller_id != current_user.id %}
                <div class="mt-2">
                  {% set existing_review_id = seller_reviews_map.get(item.seller_id) if seller_reviews_map is defined else None %}
                  {% if existing_review_id %}
                    <a href="{{ url_for('social.seller_review', seller_id=item.seller_id) }}" class="btn btn-sm btn-outline-primary">Update Review</a>
                    <div class="small text-muted mt-1">You have already reviewed this seller.</div>
                  {% else %}
                    <a href="{{ url_for('social.seller_review', seller_id=item.seller_id) }}" class="btn btn-sm btn-outline-primary">Save Review</a>
                  {% endif %}
                </div>
              {% endif %}
            {% else %}
              <span class="badge badge-warning">Pending</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="text-right mt-3">
    <h4>Total: ${{ "{:,.2f}".format(order.total_amount) }}</h4>
  </div>
  {% else %}
  <div class="alert alert-info">No items found for this order.</div>
  {% endif %}
</div>
{% endblock %}
