{% extends "base.html" %}

{% block content %}
<h2>Review: {{ product.name }}</h2>

<div class="mb-3">
  <p><strong>Price:</strong> ${{ "%.2f"|format(product.price) }}</p>

  {% if rating_summary and rating_summary.num_reviews > 0 %}
    <p>
      <strong>Average rating:</strong>
      {% set stars = (rating_summary.avg_rating or 0)|round(0, 'floor')|int %}
      {% for _ in range(stars) %}&#9733;{% endfor %}
      {% for _ in range(5 - stars) %}&#9734;{% endfor %}
      <small>
        ({{ "%.2f"|format(rating_summary.avg_rating) }}
         from {{ rating_summary.num_reviews }}
         review{{ 's' if rating_summary.num_reviews != 1 else '' }})
      </small>
    </p>
  {% else %}
    <p>No reviews yet.</p>
  {% endif %}
</div>

<h3>Your review</h3>
<form method="post">
  <div class="form-group">
    <label for="rating">Rating (1â€“5)</label>
    <select class="form-control" id="rating" name="rating" required>
      {% for r in range(1, 6) %}
        <option value="{{ r }}"
          {% if user_review and user_review.rating == r %}selected{% endif %}>
          {{ r }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="body">Comment</label>
    <textarea class="form-control" id="body" name="body" rows="3" required>
{% if user_review %}{{ user_review.body }}{% endif %}
</textarea>
  </div>

  <button type="submit" class="btn btn-primary">Save review</button>

  {% if user_review %}
    <button type="submit" name="delete" value="1"
            class="btn btn-danger ml-2"
            onclick="return confirm('Delete your review?');">
      Delete review
    </button>
  {% endif %}
</form>

<hr>

<h3>All reviews for this product</h3>
{% if all_reviews %}
  <table class="table table-striped">
    <thead>
      <tr>
        <th>User</th>
        <th>Rating</th>
        <th>Comment</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      {% for r in all_reviews %}
        <tr>
          <td>{{ r.firstname }} {{ r.lastname }}</td>
          <td>
            {% for _ in range(r.rating) %}&#9733;{% endfor %}
            {% for _ in range(5 - r.rating) %}&#9734;{% endfor %}
            <small>({{ r.rating }})</small>
          </td>
          <td>{{ r.body }}</td>
          <td>{{ r.created_at }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No reviews yet.</p>
{% endif %}

{% endblock %}
