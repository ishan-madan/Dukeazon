{% extends "base.html" %}

{% block content %}
{% set item_count = items|length %}
<div class="hero-panel">
  <div>
    <div class="eyebrow mb-2">Your Cart</div>
    <h1 class="mb-2">Ready when you are</h1>
    <p class="muted mb-0">{{ item_count }} {{ 'item' if item_count == 1 else 'items' }} waiting to check out.</p>
  </div>
  <div class="text-right">
    <div class="muted text-uppercase small">Current total</div>
    <div class="hero-total">${{ "{:,.2f}".format(total) }}</div>
    <div class="mt-3">
      <a href="{{ url_for('cart.orders', user_id=user_id) }}" class="btn btn-outline-light btn-sm mr-2">Order History</a>
      <a href="/" class="btn btn-light btn-sm text-dark">Continue Shopping</a>
    </div>
  </div>
</div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info card-lift">
    {% for message in messages %}
      <div>{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}
{% endwith %}

{% if items %}
  <div class="card card-lift mb-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-modern mb-0">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Product</th>
              <th scope="col">Seller</th>
              <th scope="col" class="text-right">Unit Price</th>
              <th scope="col" style="width:180px;">Quantity</th>
              <th scope="col" class="text-right">Subtotal</th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>
                <strong>{{ item.product_name }}</strong>
                <div class="text-muted small">Listing #{{ item.listing_id }}</div>
              </td>
              <td>{{ item.seller_name }}</td>
              <td class="text-right">${{ "{:,.2f}".format(item.unit_price) }}</td>
              <td>
                <form class="d-flex align-items-center product-form-inline" method="post"
                      action="{{ url_for('cart.update_item', user_id=user_id, listing_id=item.listing_id) }}">
                  <input type="number" min="0" name="quantity" value="{{ item.quantity }}"
                         class="form-control form-control-sm">
                  <button type="submit" class="btn btn-sm btn-outline-primary">Save</button>
                </form>
              </td>
              <td class="text-right">${{ "{:,.2f}".format(item.subtotal) }}</td>
              <td class="text-center">
                <form method="post"
                      action="{{ url_for('cart.remove_item', user_id=user_id, listing_id=item.listing_id) }}"
                      onsubmit="return confirm('Remove this item?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center px-4 py-3 border-top">
      <div class="text-muted">You're almost there! Review totals then complete checkout.</div>
      <div class="text-md-right mt-3 mt-md-0">
        <div class="text-uppercase small text-muted">Total</div>
        <h3 class="mb-0">${{ "{:,.2f}".format(total) }}</h3>
      </div>
    </div>
    <div class="px-4 pb-4 text-md-right">
      <form method="post" action="{{ url_for('cart.checkout', user_id=user_id) }}">
        <button type="submit" class="btn btn-primary btn-lg mt-3">Checkout Securely</button>
      </form>
    </div>
  </div>
{% else %}
  <div class="card card-lift text-center p-5">
    <h4>Your cart is currently empty.</h4>
    <p class="text-muted mb-4">Find something you love and it will appear here.</p>
    <a href="/" class="btn btn-primary mr-2">Browse Products</a>
    <a href="{{ url_for('cart.orders', user_id=user_id) }}" class="btn btn-outline-secondary mt-3 mt-sm-0">View Orders</a>
  </div>
{% endif %}
{% endblock %}
