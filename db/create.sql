-- Feel free to modify this file to match your development goal.
-- Here we only create 3 tables for demo purpose.

CREATE TABLE Users (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    email VARCHAR UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    firstname VARCHAR(255) NOT NULL,
    lastname VARCHAR(255) NOT NULL,
    address VARCHAR(255) NOT NULL,
    balance DECIMAL(12,2) NOT NULL DEFAULT 0,
    is_seller BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE Categories (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(255) UNIQUE NOT NULL
);

CREATE TABLE Products (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    category_id INT NOT NULL REFERENCES Categories(id),
    category_name VARCHAR(255),
    name VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    price DECIMAL(12,2) NOT NULL CHECK (price > 0),
    available BOOLEAN DEFAULT TRUE,
    creator_id INT REFERENCES Users(id),
    image_link TEXT
);

CREATE TABLE Purchases (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    uid INT NOT NULL REFERENCES Users(id),
    pid INT NOT NULL REFERENCES Products(id),
    time_purchased timestamp without time zone NOT NULL DEFAULT (current_timestamp AT TIME ZONE 'UTC')
);

CREATE TABLE ProductSeller (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    seller_id INT NOT NULL REFERENCES Users(id),
    product_id INT NOT NULL REFERENCES Products(id),
    price DECIMAL(12,2) NOT NULL CHECK (price > 0),
    quantity INT NOT NULL CHECK (quantity >= 0),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    UNIQUE (seller_id, product_id)
);

CREATE TABLE Cart (
  user_id INTEGER NOT NULL REFERENCES Users(id),
  product_id INTEGER NOT NULL REFERENCES Products(id),
  listing_id INTEGER NOT NULL REFERENCES ProductSeller(id),
  seller_id INTEGER NOT NULL REFERENCES Users(id),
  unit_price DECIMAL(12,2) NOT NULL CHECK (unit_price >= 0),
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  PRIMARY KEY (user_id, listing_id)
);

CREATE INDEX cart_user_idx ON Cart(user_id);

CREATE TABLE Orders (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id INT NOT NULL REFERENCES Users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    status VARCHAR(32) NOT NULL DEFAULT 'pending',
    total_amount DECIMAL(12,2) NOT NULL CHECK (total_amount >= 0)
);

CREATE INDEX orders_user_created_idx ON Orders(user_id, created_at DESC);

CREATE TABLE OrderItems (
    id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    order_id INT NOT NULL REFERENCES Orders(id) ON DELETE CASCADE,
    listing_id INT NOT NULL REFERENCES ProductSeller(id),
    seller_id INT NOT NULL REFERENCES Users(id),
    product_id INT NOT NULL REFERENCES Products(id),
    unit_price DECIMAL(12,2) NOT NULL CHECK (unit_price >= 0),
    quantity INT NOT NULL CHECK (quantity > 0),
    subtotal DECIMAL(12,2) NOT NULL CHECK (subtotal >= 0),
    fulfilled BOOLEAN NOT NULL DEFAULT FALSE,
    fulfilled_at TIMESTAMPTZ,
    fulfillment_status VARCHAR(32) NOT NULL DEFAULT 'Order Placed'
);

CREATE INDEX order_items_order_idx ON OrderItems(order_id);
CREATE INDEX order_items_seller_idx ON OrderItems(seller_id);

-- Social / Feedback tables --
CREATE TABLE IF NOT EXISTS product_reviews (
  product_review_id SERIAL PRIMARY KEY,
  product_id INT NOT NULL REFERENCES Products(id),
  user_id    INT NOT NULL REFERENCES Users(id),
  rating     INT CHECK (rating BETWEEN 1 AND 5),
  body       TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS seller_reviews (
  seller_review_id SERIAL PRIMARY KEY,
  seller_id  INT NOT NULL REFERENCES Users(id),
  user_id    INT NOT NULL REFERENCES Users(id),
  rating     INT CHECK (rating BETWEEN 1 AND 5),
  body       TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Votes that mark a product/seller review as helpful.
-- We allow one vote per user per review, across both review types.
CREATE TABLE IF NOT EXISTS review_votes (
  vote_id     SERIAL PRIMARY KEY,
  review_type VARCHAR(10) NOT NULL CHECK (review_type IN ('product', 'seller')),
  review_id   INT NOT NULL,
  user_id     INT NOT NULL REFERENCES Users(id),
  vote        SMALLINT NOT NULL DEFAULT 1 CHECK (vote = 1),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(review_type, review_id, user_id)
);
CREATE INDEX IF NOT EXISTS review_votes_lookup_idx
  ON review_votes(review_type, review_id);
